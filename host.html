<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Feud Host Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* Add any custom styles here if needed */
    </style>
</head>
<body class="bg-gray-200 p-6">

    <div class="container mx-auto">
        <h1 class="text-4xl font-bold text-center mb-8 text-gray-800">Family Feud Host Panel</h1>

        <div class="bg-blue-100 p-4 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-bold mb-4 text-blue-800">Game Version Management</h2>
            <div class="flex flex-wrap items-end gap-4 mb-4">
                <div class="flex-grow">
                    <label for="gameNameInput" class="block text-sm font-medium text-gray-700 mb-1">Game Version Name:</label>
                    <input type="text" id="gameNameInput" placeholder="e.g., 'Family Reunion Game'" class="p-2 border rounded-md w-full focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button onclick="saveGameVersion()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 text-sm">üíæ Save Current Game As...</button>
            </div>

            <div class="flex flex-wrap items-end gap-4">
                <div class="flex-grow">
                    <label for="gameSelector" class="block text-sm font-medium text-gray-700 mb-1">Load Game Version:</label>
                    <select id="gameSelector" class="p-2 border rounded-md w-full bg-white focus:ring-blue-500 focus:border-blue-500">
                        <option value="">-- Select a game --</option>
                        </select>
                </div>
                <button onclick="loadSelectedGameVersion()" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 text-sm">üì§ Load Selected Game</button>
                <button onclick="deleteSelectedGameVersion()" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 text-sm">üóëÔ∏è Delete Selected Game</button>
            </div>
        </div>


        <div class="bg-gray-100 p-4 rounded-lg shadow-md flex justify-around items-center mb-8">
            <button onclick="startGame()" class="bg-green-600 text-white px-6 py-3 rounded-lg text-xl font-bold hover:bg-green-700">üöÄ Start Game</button>
            <button onclick="addStrike()" class="bg-red-500 text-white px-4 py-2 rounded-lg text-lg hover:bg-red-600">‚ùå Add Strike</button>
            <button onclick="resetStrikes()" class="bg-gray-500 text-white px-4 py-2 rounded-lg text-lg hover:bg-gray-600">üö´ Reset Strikes</button>
            <button onclick="nextRound()" class="bg-emerald-500 text-white px-6 py-3 rounded-lg text-lg font-bold hover:bg-yellow-500">‚û°Ô∏è Next Round</button>
        </div>

        <div class="bg-gray-100 p-4 rounded-lg shadow-md flex justify-around items-center mb-8">
            <div class="flex items-center space-x-4">
                <label for="scoreAInput" class="text-lg font-semibold">Team A Score:</label>
                <input type="number" id="scoreAInput" value="0" class="w-24 p-2 border rounded-md text-center text-xl font-bold">
                <button onclick="setScore('A')" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">Set A</button>
            </div>
            <button onclick="resetScores()" class="bg-purple-500 text-white px-4 py-2 rounded-lg text-lg hover:bg-purple-600">üîÑ Reset Scores</button>
            <div class="flex items-center space-x-4">
                <label for="scoreBInput" class="text-lg font-semibold">Team B Score:</label>
                <input type="number" id="scoreBInput" value="0" class="w-24 p-2 border rounded-md text-center text-xl font-bold">
                <button onclick="setScore('B')" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">Set B</button>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Normal Rounds</h2>
                <button onclick="addRound()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">‚ûï Add Round</button>
            </div>
            <div id="roundsContainer">
                </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Fast Money Rounds</h2>
                <div class="flex gap-2">
                    <button onclick="addFastMoneyRound()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">‚ûï Add Fast Money Round</button>
                </div>
            </div>
            <div id="fastMoneyContainer">
                </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getDatabase, ref, set, get, remove, onValue, off } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCS99cX6swqx4--HiWD_kDh1cZVFXc2KfE",
            authDomain: "family-feud-game-13f89.firebaseapp.com",
            projectId: "family-feud-game-13f89",
            storageBucket: "family-feud-game-13f89.appspot.com",
            messagingSenderId: "911043163745",
            appId: "1:911043163745:web:dce176591585a093a21c20",
            measurementId: "G-Q2S4LXF4XM",
            databaseURL: "https://family-feud-game-13f89-default-rtdb.firebaseio.com/"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let roundCount = 0;
        let fastMoneyCount = 0;
        let currentGameName = ""; // New: To keep track of the currently loaded/saved game version

        // Get references to the new HTML elements
        const gameNameInput = document.getElementById("gameNameInput");
        const gameSelector = document.getElementById("gameSelector");

        // Helper to create answer input for normal rounds
        function createAnswerInput(answer = "", points = 0, revealCallback = null) {
            const div = document.createElement("div");
            div.className = "flex items-center gap-2 mb-2";
            div.innerHTML = `
                <input type="text" placeholder="Answer" class="answerText p-2 border rounded w-2/5" value="${answer}">
                <input type="number" placeholder="Points" class="answerPoints p-2 border rounded w-1/5" value="${points}">
                <button class="revealBtn bg-yellow-500 text-white px-2 py-1 rounded">Reveal</button>
            `;
            if (revealCallback) {
                div.querySelector(".revealBtn").onclick = revealCallback;
            }
            return div;
        }

        // --- Add Normal Round ---
        window.addRound = function (prefill = null) {
            const container = document.getElementById("roundsContainer");
            const div = document.createElement("div");
            div.className = "mb-8 p-4 border rounded bg-white";
            const currentRoundIndex = roundCount; // Store the index for this round

            div.innerHTML = `
                <h2 class="text-xl font-bold mb-2">Round ${currentRoundIndex + 1}</h2>
                <div class="mb-2">
                    <label class="block mb-1 font-semibold">Question:</label>
                    <input type="text" class="questionInput w-full p-2 border rounded" value="${prefill?.question || ''}">
                </div>
                <div class="answersContainer"></div>
                <button class="addAnswerBtn mt-2 px-3 py-1 bg-blue-500 text-white rounded">Add Answer</button>
            `;

            const answersContainer = div.querySelector(".answersContainer");
            (prefill?.answers || []).forEach((answer, answerIndex) => {
                const ansDiv = createAnswerInput(answer.text, answer.points, () => revealAnswer(currentRoundIndex, answerIndex));
                answersContainer.appendChild(ansDiv);
            });

            div.querySelector(".addAnswerBtn").onclick = () => {
                const answerIndex = answersContainer.children.length;
                const ansDiv = createAnswerInput("", 0, () => revealAnswer(currentRoundIndex, answerIndex));
                answersContainer.appendChild(ansDiv);
            };

            container.appendChild(div);
            roundCount++;
            updateRoundLabels();
        };


        // Render normal rounds (initial load)
        function renderSavedRounds(rounds = []) {
            if (!Array.isArray(rounds)) return;

            const container = document.getElementById("roundsContainer");
            container.innerHTML = ""; // Clear existing rounds
            roundCount = 0; // Reset count before rendering

            rounds.forEach((round) => {
                window.addRound(round); // Use the addRound function to render
            });
        }

        // --- Fast Money Data Handling ---

        // Function to load and render fast money data from Firebase
        function loadFastMoneyData(fastMoneyRounds = []) { // Now accepts fastMoneyRounds as an argument
            const container = document.getElementById("fastMoneyContainer");
            container.innerHTML = ""; // Clear existing
            fastMoneyCount = 0; // Reset count before rendering

            fastMoneyRounds.forEach(round => {
                if (round && Array.isArray(round.questions)) {
                    window.addFastMoneyRound(round); // Use addFastMoneyRound to render
                }
            });
            if (fastMoneyRounds.length === 0) {
                console.warn("No fast money data provided to loadFastMoneyData.");
            }
        }

        // Add Fast Money Round function
        window.addFastMoneyRound = function (prefill = null) {
            const container = document.getElementById("fastMoneyContainer");
            const div = document.createElement("div");
            div.className = "mb-10 p-4 border rounded bg-white fast-money-round";
            const currentFastMoneyRoundIndex = fastMoneyCount; // Capture index for closures

            div.innerHTML = `
                <h3 class="text-lg font-bold mb-4">Fast Money Round ${currentFastMoneyRoundIndex + 1}</h3>
                <div class="flex flex-col gap-6"></div>
            `;

            const content = div.querySelector(".flex.flex-col.gap-6");

            for (let i = 0; i < 5; i++) {
                const row = document.createElement("div");
                row.className = "flex gap-4 items-start w-full fast-money-question-row"; // Add a class for easy selection later

                const leftCol = document.createElement("div");
                leftCol.className = "w-1/3 flex flex-col gap-2";

                const currentQuestion = prefill?.questions?.[i] || {};

                const qInput = document.createElement("input");
                qInput.type = "text";
                qInput.placeholder = `Question ${i + 1}`;
                qInput.className = "p-2 border rounded w-full text-sm";
                qInput.value = currentQuestion.question || "";

                const answerRow1 = document.createElement("div");
                answerRow1.className = "flex gap-2 items-center";

                const aInput1 = document.createElement("input");
                aInput1.type = "text";
                aInput1.placeholder = "Contestant Answer 1";
                aInput1.className = "p-1 border rounded w-4/5 text-sm contestant-answer-1";
                aInput1.value = currentQuestion.contestantAnswer1 || "";

                const ptsInput1 = document.createElement("input");
                ptsInput1.type = "number";
                ptsInput1.placeholder = "Pts 1";
                ptsInput1.className = "p-1 border rounded w-1/5 text-sm contestant-points-1";
                ptsInput1.value = currentQuestion.contestantPoints1 || "";

                answerRow1.appendChild(aInput1);
                answerRow1.appendChild(ptsInput1);

                const answerRow2 = document.createElement("div");
                answerRow2.className = "flex gap-2 items-center";

                const aInput2 = document.createElement("input");
                aInput2.type = "text";
                aInput2.placeholder = "Contestant Answer 2";
                aInput2.className = "p-1 border rounded w-4/5 text-sm contestant-answer-2";
                aInput2.value = currentQuestion.contestantAnswer2 || "";

                const ptsInput2 = document.createElement("input");
                ptsInput2.type = "number";
                ptsInput2.placeholder = "Pts 2";
                ptsInput2.className = "p-1 border rounded w-1/5 text-sm contestant-points-2";
                ptsInput2.value = currentQuestion.contestantPoints2 || "";

                answerRow2.appendChild(aInput2);
                answerRow2.appendChild(ptsInput2);

                // Buttons to reveal contestant answers/points (for display logic)
                const revealContestantAnswersBtn = document.createElement("button");
                revealContestantAnswersBtn.className = "bg-yellow-500 text-white px-2 py-1 rounded text-sm w-full revealContestantAnswersBtn";
                revealContestantAnswersBtn.textContent = `Reveal Contestant Answers`;
                revealContestantAnswersBtn.onclick = () => revealContestantAnswers(currentFastMoneyRoundIndex, i);

                const revealContestantPointsBtn = document.createElement("button");
                revealContestantPointsBtn.className = "bg-yellow-600 text-white px-2 py-1 rounded text-sm w-full revealContestantPointsBtn";
                revealContestantPointsBtn.textContent = `Reveal Contestant Points`;
                revealContestantPointsBtn.onclick = () => revealContestantPoints(currentFastMoneyRoundIndex, i);

                leftCol.appendChild(qInput);
                leftCol.appendChild(answerRow1);
                leftCol.appendChild(answerRow2);
                leftCol.appendChild(revealContestantAnswersBtn);
                leftCol.appendChild(revealContestantPointsBtn);

                const rightCol = document.createElement("div");
                rightCol.className = "w-2/3 flex flex-col gap-2";

                const topAnswersWrap = document.createElement("div");
                topAnswersWrap.className = "flex flex-wrap gap-2 w-full";

                for (let j = 0; j < 5; j++) {
                    const ansWrap = document.createElement("div");
                    ansWrap.className = "w-[18%] bg-gray-50 p-2 rounded border flex flex-col gap-1";

                    const topAnswer = currentQuestion.topAnswers?.[j] || {};

                    const ansInput = document.createElement("input");
                    ansInput.type = "text";
                    ansInput.placeholder = `Top Answer ${j + 1}`;
                    ansInput.className = "p-1 border rounded text-sm top-answer-input";
                    ansInput.value = topAnswer.text || "";

                    const ptsInput = document.createElement("input");
                    ptsInput.type = "number";
                    ptsInput.placeholder = "Pts";
                    ptsInput.className = "p-1 border rounded text-sm top-answer-points";
                    ptsInput.value = topAnswer.points || "";

                    ansWrap.appendChild(ansInput);
                    ansWrap.appendChild(ptsInput);
                    topAnswersWrap.appendChild(ansWrap);
                }

                const revealTopAnswersBtn = document.createElement("button");
                revealTopAnswersBtn.className = "bg-yellow-700 text-white px-2 py-1 rounded text-sm w-full revealTopAnswersBtn";
                revealTopAnswersBtn.textContent = "Reveal Top Answers & Points";
                revealTopAnswersBtn.onclick = () => revealAllTopFastMoneyAnswers(currentFastMoneyRoundIndex, i); // Reveals all top answers for this question

                rightCol.appendChild(topAnswersWrap);
                rightCol.appendChild(revealTopAnswersBtn);

                row.appendChild(leftCol);
                row.appendChild(rightCol);
                content.appendChild(row);
            }

            container.appendChild(div);
            fastMoneyCount++;
            updateFastMoneyLabels();
        };


        // Update round labels after adding/removing rounds
        function updateRoundLabels() {
            const roundDivs = document.querySelectorAll("#roundsContainer > div");
            roundDivs.forEach((div, i) => {
                const h2 = div.querySelector("h2");
                if (h2) h2.textContent = `Round ${i + 1}`;
                // Also update the reveal button callbacks to reflect new indices
                div.querySelectorAll(".revealBtn").forEach((btn, answerIndex) => {
                    btn.onclick = () => revealAnswer(i, answerIndex);
                });
            });
            roundCount = roundDivs.length;
        }

        // Update fast money round labels and button callbacks
        function updateFastMoneyLabels() {
            const fmDivs = document.querySelectorAll("#fastMoneyContainer > div");
            fmDivs.forEach((div, i) => {
                const h3 = div.querySelector("h3");
                if (h3) h3.textContent = `Fast Money Round ${i + 1}`;

                // Update reveal button callbacks for fast money questions
                div.querySelectorAll(".fast-money-question-row").forEach((row, qIndex) => {
                    // Ensure these buttons are correctly selected with their class names
                    const revealAnsBtn = row.querySelector(".revealContestantAnswersBtn");
                    if (revealAnsBtn) revealAnsBtn.onclick = () => revealContestantAnswers(i, qIndex);

                    const revealPtsBtn = row.querySelector(".revealContestantPointsBtn");
                    if (revealPtsBtn) revealPtsBtn.onclick = () => revealContestantPoints(i, qIndex);

                    const revealTopBtn = row.querySelector(".revealTopAnswersBtn");
                    if (revealTopBtn) revealTopBtn.onclick = () => revealAllTopFastMoneyAnswers(i, qIndex);
                });
            });
            fastMoneyCount = fmDivs.length;
        }


        // --- Reveal normal round answer ---
        function revealAnswer(roundIndex, answerIndex) {
            if (!currentGameName) {
                alert("Please load or name a game version before revealing answers.");
                return;
            }
            const gameRef = ref(db, `games/${currentGameName}`); // Use currentGameName
            get(gameRef).then(snapshot => {
                const data = snapshot.val() || {};
                // Ensure the rounds and specific round exist
                if (!data.rounds?.[roundIndex]) {
                    console.warn(`Attempted to reveal answer for non-existent round ${roundIndex}`);
                    return;
                }
                // Initialize revealed array if it doesn't exist
                if (!data.rounds[roundIndex].revealed) {
                    data.rounds[roundIndex].revealed = Array(data.rounds[roundIndex].answers.length).fill(false);
                }
                // Only update if not already revealed
                if (!data.rounds[roundIndex].revealed[answerIndex]) {
                    data.rounds[roundIndex].revealed[answerIndex] = true;
                    set(gameRef, data)
                        .then(() => console.log(`Revealed answer ${answerIndex} in round ${roundIndex} for game ${currentGameName}`))
                        .catch(err => console.error("Error revealing answer:", err));
                }
            }).catch(error => {
                console.error("Error fetching game data for revealAnswer:", error);
            });
        }

        // --- Reveal contestant answers for a Fast Money question ---
        function revealContestantAnswers(fmRoundIndex, questionIndex) {
            if (!currentGameName) {
                alert("Please load or name a game version before revealing answers.");
                return;
            }
            const gameRef = ref(db, `games/${currentGameName}`); // Use currentGameName
            get(gameRef).then(snapshot => {
                const data = snapshot.val() || {};
                const fmRound = data.fastMoneyRounds?.[fmRoundIndex];
                if (!fmRound?.questions?.[questionIndex]) {
                    console.warn(`Attempted to reveal contestant answers for non-existent Fast Money question ${questionIndex} in round ${fmRoundIndex}`);
                    return;
                }
                // Set flags to reveal contestant answers (if not already revealed)
                if (!fmRound.questions[questionIndex].revealedContestantAnswer1) {
                    fmRound.questions[questionIndex].revealedContestantAnswer1 = true;
                }
                if (!fmRound.questions[questionIndex].revealedContestantAnswer2) {
                    fmRound.questions[questionIndex].revealedContestantAnswer2 = true;
                }
                set(gameRef, data);
            }).catch(error => {
                console.error("Error revealing Fast Money contestant answers:", error);
            });
        }

        // --- Reveal contestant points for a Fast Money question ---
        function revealContestantPoints(fmRoundIndex, questionIndex) {
            if (!currentGameName) {
                alert("Please load or name a game version before revealing points.");
                return;
            }
            const gameRef = ref(db, `games/${currentGameName}`); // Use currentGameName
            get(gameRef).then(snapshot => {
                const data = snapshot.val() || {};
                const fmRound = data.fastMoneyRounds?.[fmRoundIndex];
                if (!fmRound?.questions?.[questionIndex]) {
                    console.warn(`Attempted to reveal contestant points for non-existent Fast Money question ${questionIndex} in round ${fmRoundIndex}`);
                    return;
                }
                // Set flags to reveal contestant points (if not already revealed)
                if (!fmRound.questions[questionIndex].revealedContestantPoints1) {
                    fmRound.questions[questionIndex].revealedContestantPoints1 = true;
                }
                if (!fmRound.questions[questionIndex].revealedContestantPoints2) {
                    fmRound.questions[questionIndex].revealedContestantPoints2 = true;
                }
                set(gameRef, data);
            }).catch(error => {
                console.error("Error revealing Fast Money contestant points:", error);
            });
        }

        // --- Reveal all top answers and their points for a Fast Money question ---
        function revealAllTopFastMoneyAnswers(fmRoundIndex, questionIndex) {
            if (!currentGameName) {
                alert("Please load or name a game version before revealing top answers.");
                return;
            }
            const gameRef = ref(db, `games/${currentGameName}`); // Use currentGameName
            get(gameRef).then(snapshot => {
                const data = snapshot.val() || {};
                const fmRound = data.fastMoneyRounds?.[fmRoundIndex];
                if (!fmRound?.questions?.[questionIndex]) {
                    console.warn(`Attempted to reveal top answers for non-existent Fast Money question ${questionIndex} in round ${fmRoundIndex}`);
                    return;
                }
                // Iterate through top answers and set both revealedAnswer and revealedPoints to true
                fmRound.questions[questionIndex].topAnswers.forEach(answer => {
                    answer.revealedAnswer = true;
                    answer.revealedPoints = true;
                });
                set(gameRef, data);
            }).catch(error => {
                console.error("Error revealing all top Fast Money answers:", error);
            });
        }


        // --- Add strike ---
        window.addStrike = function () {
            if (!currentGameName) {
                alert("Please load or name a game version before adding strikes.");
                return;
            }
            const gameRef = ref(db, `games/${currentGameName}`); // Use currentGameName
            get(gameRef).then(snapshot => {
                const data = snapshot.val() || {};
                const currentRoundIndex = data.currentRoundIndex ?? 0; // Default to 0 if not set
                const round = data.rounds?.[currentRoundIndex];
                if (!round) {
                    console.warn("No current round found to add strike.");
                    return;
                }
                round.strikes = Math.min((round.strikes || 0) + 1, 3);
                // Ensure the rounds array and specific round are updated correctly
                if (data.rounds) {
                    data.rounds[currentRoundIndex] = round;
                } else {
                    data.rounds = [round]; // Should not happen if currentRoundIndex is valid
                }
                set(gameRef, data)
                    .then(() => console.log(`Strike added. Current strikes: ${round.strikes} for game ${currentGameName}`))
                    .catch(err => console.error("Error adding strike:", err));
            }).catch(error => {
                console.error("Error fetching game data for addStrike:", error);
            });
        };

        // --- Reset strikes ---
        window.resetStrikes = function () {
            if (!currentGameName) {
                alert("Please load or name a game version before resetting strikes.");
                return;
            }
            const gameRef = ref(db, `games/${currentGameName}`); // Use currentGameName
            get(gameRef).then(snapshot => {
                const data = snapshot.val() || {};
                const currentRoundIndex = data.currentRoundIndex ?? 0;
                if (data.rounds?.[currentRoundIndex]) {
                    data.rounds[currentRoundIndex].strikes = 0;
                    set(gameRef, data)
                        .then(() => console.log(`Strikes reset for game ${currentGameName}`))
                        .catch(err => console.error("Error resetting strikes:", err));
                } else {
                    console.warn("No current round found to reset strikes.");
                }
            }).catch(error => {
                console.error("Error fetching game data for resetStrikes:", error);
            });
        };

        // --- Set team score ---
        window.setScore = function (team) {
            if (!currentGameName) {
                alert("Please load or name a game version before setting scores.");
                return;
            }
            const inputId = team === "A" ? "scoreAInput" : "scoreBInput";
            const val = Number(document.getElementById(inputId).value);
            const scoreKey = team === "A" ? "scoreA" : "scoreB";
            const gameRef = ref(db, `games/${currentGameName}`); // Use currentGameName
            get(gameRef).then(snapshot => {
                const data = snapshot.val() || {};
                data[scoreKey] = val;
                set(gameRef, data)
                    .then(() => console.log(`Team ${team} score set to ${val} for game ${currentGameName}`))
                    .catch(err => console.error("Error setting score:", err));
            }).catch(error => {
                console.error("Error fetching game data for setScore:", error);
            });
        };

        // --- Reset scores ---
        window.resetScores = function () {
            if (!currentGameName) {
                alert("Please load or name a game version before resetting scores.");
                return;
            }
            const gameRef = ref(db, `games/${currentGameName}`); // Use currentGameName
            get(gameRef).then(snapshot => {
                const data = snapshot.val() || {};
                data.scoreA = 0;
                data.scoreB = 0;
                set(gameRef, data)
                    .then(() => console.log(`Scores reset for game ${currentGameName}`))
                    .catch(err => console.error("Error resetting scores:", err));
            }).catch(error => {
                console.error("Error fetching game data for resetScores:", error);
            });
        };

        // --- Next round ---
        window.nextRound = function () {
            if (!currentGameName) {
                alert("Please load or name a game version before advancing rounds.");
                return;
            }
            const gameRef = ref(db, `games/${currentGameName}`); // Use currentGameName
            get(gameRef).then(snapshot => {
                const data = snapshot.val() || {};
                const totalRounds = data.rounds?.length ?? 0;

                // If currently in normal rounds
                if (typeof data.currentRoundIndex === 'number') {
                    if (data.currentRoundIndex < totalRounds - 1) {
                        data.currentRoundIndex++;
                    } else if ((data.fastMoneyRounds?.length ?? 0) > 0) {
                        // Transition to Fast Money if available
                        data.currentRoundIndex = "fastMoney"; // Use a string to indicate Fast Money mode
                        data.currentFastMoneyRoundIndex = 0;
                        data.currentFastMoneyQuestionIndex = 0; // Start at the first question of the first Fast Money round
                    } else {
                        console.log("No more normal rounds or Fast Money rounds to advance to.");
                        return; // No more rounds to advance
                    }
                } else if (data.currentRoundIndex === "fastMoney") {
                    // Logic for advancing within Fast Money rounds
                    const currentFMRound = data.fastMoneyRounds?.[data.currentFastMoneyRoundIndex];
                    if (currentFMRound && data.currentFastMoneyQuestionIndex < (currentFMRound.questions?.length ?? 0) - 1) {
                        data.currentFastMoneyQuestionIndex++;
                    } else if (data.currentFastMoneyRoundIndex < (data.fastMoneyRounds?.length ?? 0) - 1) {
                        data.currentFastMoneyRoundIndex++;
                        data.currentFastMoneyQuestionIndex = 0; // Reset question index for new Fast Money round
                    } else {
                        console.log("All Fast Money rounds completed.");
                        // Optionally set a game_over state
                        data.currentRoundIndex = "gameOver";
                    }
                } else {
                    // Initial state or game over
                    data.currentRoundIndex = 0; // Start normal rounds if no state
                    data.currentFastMoneyRoundIndex = 0; // Reset FM indices
                    data.currentFastMoneyQuestionIndex = 0;
                }
                set(gameRef, data)
                    .then(() => console.log(`Advanced to next state: currentRoundIndex=${data.currentRoundIndex}, currentFMRoundIndex=${data.currentFastMoneyRoundIndex}, currentFMQIndex=${data.currentFastMoneyQuestionIndex} for game ${currentGameName}`))
                    .catch(err => console.error("Error advancing round:", err));
            }).catch(error => {
                console.error("Error fetching game data for nextRound:", error);
            });
        };


        // --- Start game (and save all current data to active game name) ---
        window.startGame = function () {
            if (!currentGameName) {
                alert("Please load or name a game version before starting/saving the game.");
                return;
            }

            // Collect normal rounds data
            const rounds = [];
            const roundDivs = document.querySelectorAll("#roundsContainer > div");
            roundDivs.forEach((div) => {
                const question = div.querySelector(".questionInput").value;
                const answerEls = div.querySelectorAll(".answerText");
                const pointEls = div.querySelectorAll(".answerPoints");
                const answers = [];

                answerEls.forEach((input, i) => {
                    const text = input.value.trim();
                    const points = parseInt(pointEls[i].value, 10);
                    if (text && !isNaN(points)) {
                        answers.push({ text, points });
                    }
                });

                // Initialize revealed answers and strikes for the round
                rounds.push({ question, answers, revealed: Array(answers.length).fill(false), strikes: 0 });
            });

            // Collect fast money rounds data
            const fastMoneyRounds = [];
            const fmDivs = document.querySelectorAll("#fastMoneyContainer > div");
            fmDivs.forEach(div => {
                const questionRows = div.querySelectorAll(".fast-money-question-row");
                const questions = [];

                questionRows.forEach(row => {
                    const question = row.querySelector("input[placeholder^='Question']")?.value || "";

                    const contestantAnswer1 = row.querySelector(".contestant-answer-1")?.value || "";
                    const contestantPoints1 = parseInt(row.querySelector(".contestant-points-1")?.value || "0", 10);

                    const contestantAnswer2 = row.querySelector(".contestant-answer-2")?.value || "";
                    const contestantPoints2 = parseInt(row.querySelector(".contestant-points-2")?.value || "0", 10);

                    const topAnswers = Array.from(row.querySelectorAll(".top-answer-input")).map((input, idx) => {
                        const pointsInput = row.querySelectorAll(".top-answer-points")[idx];
                        return {
                            text: input.value,
                            points: parseInt(pointsInput?.value || "0", 10),
                            revealedAnswer: false, // Default state
                            revealedPoints: false  // Default state
                        };
                    });

                    questions.push({
                        question,
                        contestantAnswer1,
                        contestantPoints1,
                        revealedContestantAnswer1: false,
                        revealedContestantPoints1: false,
                        contestantAnswer2,
                        contestantPoints2,
                        revealedContestantAnswer2: false,
                        revealedContestantPoints2: false,
                        topAnswers
                    });
                });
                fastMoneyRounds.push({ questions });
            });

            const gameRef = ref(db, `games/${currentGameName}`); // Save to the currently active game name
            set(gameRef, {
                rounds,
                fastMoneyRounds, // Ensure fastMoneyRounds are part of the game object
                currentRoundIndex: 0, // Start with the first normal round
                scoreA: 0,
                scoreB: 0,
                // New Fast Money state variables
                currentFastMoneyRoundIndex: 0,
                currentFastMoneyQuestionIndex: 0,
                fastMoneyTimerRunning: false,
                fastMoneyTimeRemaining: 30, // Example: 30 seconds for the timer
                fastMoneyTotalPoints: 0 // To accumulate points in Fast Money
            })
                .then(() => {
                    console.log(`Game "${currentGameName}" started and data sent to Firebase!`);
                    alert(`üöÄ Game "${currentGameName}" Started and Saved! Data sent to display.`);
                })
                .catch(error => {
                    console.error("Error starting game:", error);
                    alert("‚ùå Failed to start game.");
                });
        };


        // --- New Game Version Management Functions ---

        // Populates the dropdown with saved game names from Firebase
        function populateGameSelector(currentGames = {}) {
            gameSelector.innerHTML = '<option value="">-- Select a game --</option>'; // Clear existing options
            const gameNames = Object.keys(currentGames);
            gameNames.forEach(name => {
                const option = document.createElement("option");
                option.value = name;
                option.textContent = name;
                gameSelector.appendChild(option);
            });

            // Set the selected option if a game is currently active
            if (currentGameName) {
                gameSelector.value = currentGameName;
            }
        }

        // Saves the current host panel data as a new game version
        window.saveGameVersion = function () {
            const name = gameNameInput.value.trim();
            if (!name) {
                alert("Please enter a name for your game version!");
                return;
            }

            // Collect all data just like in startGame
            const rounds = [];
            document.querySelectorAll("#roundsContainer > div").forEach((div) => {
                const question = div.querySelector(".questionInput").value;
                const answerEls = div.querySelectorAll(".answerText");
                const pointEls = div.querySelectorAll(".answerPoints");
                const answers = [];
                answerEls.forEach((input, i) => {
                    const text = input.value.trim();
                    const points = parseInt(pointEls[i].value, 10);
                    if (text && !isNaN(points)) answers.push({ text, points });
                });
                rounds.push({ question, answers, revealed: Array(answers.length).fill(false), strikes: 0 });
            });

            const fastMoneyRounds = [];
            document.querySelectorAll("#fastMoneyContainer > div").forEach(div => {
                const questionRows = div.querySelectorAll(".fast-money-question-row");
                const questions = [];
                questionRows.forEach(row => {
                    const question = row.querySelector("input[placeholder^='Question']")?.value || "";
                    const contestantAnswer1 = row.querySelector(".contestant-answer-1")?.value || "";
                    const contestantPoints1 = parseInt(row.querySelector(".contestant-points-1")?.value || "0", 10);
                    const contestantAnswer2 = row.querySelector(".contestant-answer-2")?.value || "";
                    const contestantPoints2 = parseInt(row.querySelector(".contestant-points-2")?.value || "0", 10);
                    const topAnswers = Array.from(row.querySelectorAll(".top-answer-input")).map((input, idx) => {
                        const pointsInput = row.querySelectorAll(".top-answer-points")[idx];
                        return {
                            text: input.value,
                            points: parseInt(pointsInput?.value || "0", 10),
                            revealedAnswer: false, revealedPoints: false
                        };
                    });
                    questions.push({
                        question, contestantAnswer1, contestantPoints1, revealedContestantAnswer1: false, revealedContestantPoints1: false,
                        contestantAnswer2, contestantPoints2, revealedContestantAnswer2: false, revealedContestantPoints2: false,
                        topAnswers
                    });
                });
                fastMoneyRounds.push({ questions });
            });

            const gameData = {
                rounds,
                fastMoneyRounds,
                currentRoundIndex: 0, // Reset state for saved version
                scoreA: 0,
                scoreB: 0,
                currentFastMoneyRoundIndex: 0,
                currentFastMoneyQuestionIndex: 0,
                fastMoneyTimerRunning: false,
                fastMoneyTimeRemaining: 30,
                fastMoneyTotalPoints: 0
            };

            const gameRef = ref(db, `games/${name}`);
            set(gameRef, gameData)
                .then(() => {
                    alert(`‚úÖ Game version "${name}" saved successfully!`);
                    console.log(`Game version "${name}" saved.`);
                    currentGameName = name; // Set this as the currently active game
                    gameNameInput.value = name; // Update input field
                    gameSelector.value = name; // Update selector
                    // No need to call populateGameSelector here, onValue listener will handle it
                })
                .catch(error => {
                    console.error("Error saving game version:", error);
                    alert("‚ùå Failed to save game version.");
                });
        };

        // Loads a selected game version into the host panel
        window.loadSelectedGameVersion = function () {
            const name = gameSelector.value;
            if (!name) {
                alert("Please select a game version to load.");
                return;
            }

            const gameRef = ref(db, `games/${name}`);
            get(gameRef).then(snapshot => {
                const data = snapshot.val();
                if (data) {
                    // Clear current host panel
                    document.getElementById("roundsContainer").innerHTML = "";
                    document.getElementById("fastMoneyContainer").innerHTML = "";
                    roundCount = 0;
                    fastMoneyCount = 0;

                    // Render loaded data
                    renderSavedRounds(data.rounds || []);
                    loadFastMoneyData(data.fastMoneyRounds || []); // Pass loaded data to FM renderer

                    currentGameName = name; // Set the current active game
                    gameNameInput.value = name; // Update the input field

                    // Optionally, update scores display (if you have score inputs)
                    document.getElementById("scoreAInput").value = data.scoreA ?? 0;
                    document.getElementById("scoreBInput").value = data.scoreB ?? 0;


                    alert(`üéâ Game version "${name}" loaded successfully!`);
                    console.log(`Game version "${name}" loaded.`);

                    // Important: Set the active game for the display panel as well
                    set(ref(db, 'activeGame'), name)
                        .then(() => console.log(`Active game set to ${name} for display.`))
                        .catch(err => console.error("Error setting active game for display:", err));

                } else {
                    alert(`‚ùå Game version "${name}" not found.`);
                    console.warn(`Game version "${name}" not found.`);
                }
            }).catch(error => {
                console.error("Error loading game version:", error);
                alert("‚ùå Failed to load game version.");
            });
        };

        // Deletes a selected game version
        window.deleteSelectedGameVersion = function () {
            const name = gameSelector.value;
            if (!name) {
                alert("Please select a game version to delete.");
                return;
            }

            if (!confirm(`Are you sure you want to delete the game version "${name}"? This cannot be undone.`)) {
                return;
            }

            const gameRef = ref(db, `games/${name}`);
            remove(gameRef)
                .then(() => {
                    alert(`üóëÔ∏è Game version "${name}" deleted.`);
                    console.log(`Game version "${name}" deleted.`);
                    if (currentGameName === name) {
                        currentGameName = ""; // Clear active game if deleted
                        gameNameInput.value = "";
                        // Clear host panel if the active game was deleted
                        document.getElementById("roundsContainer").innerHTML = "";
                        document.getElementById("fastMoneyContainer").innerHTML = "";
                        roundCount = 0;
                        fastMoneyCount = 0;
                        // Also clear the active game on the display
                        set(ref(db, 'activeGame'), "");
                    }
                    // onValue listener for 'games' will re-populate gameSelector
                })
                .catch(error => {
                    console.error("Error deleting game version:", error);
                    alert("‚ùå Failed to delete game version.");
                });
        };


        // Load saved data on page load
        window.addEventListener("DOMContentLoaded", () => {
            // Listener for all game versions to populate the dropdown
            onValue(ref(db, 'games'), (snapshot) => {
                const games = snapshot.val() || {};
                populateGameSelector(games);
                // If there's an activeGame set in Firebase, try to load it
                get(ref(db, 'activeGame')).then(activeGameSnapshot => {
                    const activeGame = activeGameSnapshot.val();
                    if (activeGame && games[activeGame]) {
                        if (currentGameName !== activeGame) { // Prevent re-loading if already loaded
                            console.log(`Attempting to load previously active game: ${activeGame}`);
                            // Set currentGameName and gameNameInput first, then call loadSelectedGameVersion
                            currentGameName = activeGame;
                            gameNameInput.value = activeGame;
                            gameSelector.value = activeGame; // Ensure dropdown is set
                            loadSelectedGameVersion(); // This will trigger rendering and alert
                        }
                    } else {
                        // If no active game, or active game doesn't exist, ensure panel is empty
                        document.getElementById("roundsContainer").innerHTML = "";
                        document.getElementById("fastMoneyContainer").innerHTML = "";
                        roundCount = 0;
                        fastMoneyCount = 0;
                        currentGameName = "";
                        gameNameInput.value = "";
                        gameSelector.value = "";
                        set(ref(db, 'activeGame'), ""); // Clear active game in Firebase if it's invalid
                    }
                });
            }, (error) => {
                console.error("Error listening for games:", error);
            });
        });
    </script>
</body>
</html>
