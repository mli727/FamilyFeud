<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Family Feud Host</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
  <h1 class="text-3xl font-bold mb-6">ðŸŽ® Host Panel</h1>

  <div id="roundsContainer"></div>
  <button onclick="addRound()" class="mb-6 px-4 py-2 bg-blue-600 text-white rounded">Add Round</button>

  <hr class="my-8" />

  <h2 class="text-2xl font-bold mb-4">Fast Money Rounds</h2>
  <div id="fastMoneyContainer"></div>
  <button onclick="addFastMoneyRound()" class="mb-6 px-4 py-2 bg-purple-600 text-white rounded">Add Fast Money Round</button>

  <hr class="my-8" />

  <button onclick="startGame()" class="mb-6 px-6 py-3 bg-green-600 text-white rounded text-lg font-semibold">Start Game</button>

  <div class="flex gap-4 mb-6">
    <button onclick="addStrike()" class="px-4 py-2 bg-red-500 text-white rounded">Add Strike</button>
    <button onclick="resetStrikes()" class="px-4 py-2 bg-gray-700 text-white rounded">Reset Strikes</button>
    <button onclick="nextRound()" class="px-4 py-2 bg-indigo-600 text-white rounded">Next Round</button>
  </div>

  <div class="flex gap-4 mb-6">
    <input type="number" id="scoreAInput" placeholder="Team A score" class="p-2 border rounded w-32" />
    <button onclick="setScore('A')" class="px-4 py-2 bg-yellow-500 text-white rounded">Set Team A</button>
    <input type="number" id="scoreBInput" placeholder="Team B score" class="p-2 border rounded w-32" />
    <button onclick="setScore('B')" class="px-4 py-2 bg-yellow-600 text-white rounded">Set Team B</button>
    <button onclick="resetScores()" class="px-4 py-2 bg-gray-700 text-white rounded">Reset Scores</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCS99cX6swqx4--HiWD_kDh1cZVFXc2KfE",
      authDomain: "family-feud-game-13f89.firebaseapp.com",
      projectId: "family-feud-game-13f89",
      storageBucket: "family-feud-game-13f89.appspot.com",
      messagingSenderId: "911043163745",
      appId: "1:911043163745:web:dce176591585a093a21c20",
      measurementId: "G-Q2S4LXF4XM",
      databaseURL: "https://family-feud-game-13f89-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Global counters for rounds
    let roundCount = 0;
    let fastMoneyCount = 0;

    // --- Helper to create answer input group ---
    function createAnswerInput(answer = "", points = "", revealCallback = null) {
      const div = document.createElement("div");
      div.className = "flex items-center gap-2 mb-2";
      div.innerHTML = `
        <input type="text" placeholder="Answer" class="answerText p-2 border rounded w-2/5" value="${answer}">
        <input type="number" placeholder="Points" class="answerPoints p-2 border rounded w-1/5" value="${points}">
        <button class="revealBtn bg-yellow-500 text-white px-2 py-1 rounded">Reveal</button>
      `;
      if (revealCallback) {
        div.querySelector(".revealBtn").onclick = revealCallback;
      }
      return div;
    }

    // --- Render normal rounds ---
    function renderSavedRounds(rounds) {
      const container = document.getElementById("roundsContainer");
      container.innerHTML = "";
      roundCount = 0;

      rounds.forEach((round, roundIndex) => {
        const div = document.createElement("div");
        div.className = "mb-8 p-4 border rounded bg-white";
        div.innerHTML = `
          <h2 class="text-xl font-bold mb-2">Round ${roundIndex + 1}</h2>
          <div class="mb-2">
            <label class="block mb-1 font-semibold">Question:</label>
            <input type="text" class="questionInput w-full p-2 border rounded" value="${round.question || ''}">
          </div>
          <div class="answersContainer"></div>
          <button class="addAnswerBtn mt-2 px-3 py-1 bg-blue-500 text-white rounded">Add Answer</button>
        `;

        const answersContainer = div.querySelector(".answersContainer");
        round.answers.forEach((answer, answerIndex) => {
          const ansDiv = createAnswerInput(answer.text, answer.points, () => revealAnswer(roundIndex, answerIndex));
          answersContainer.appendChild(ansDiv);
        });

        const addAnswerBtn = div.querySelector(".addAnswerBtn");
        addAnswerBtn.onclick = () => {
          const answerIndex = div.querySelector(".answersContainer").children.length;
          const ansDiv = createAnswerInput("", "", () => revealAnswer(roundIndex, answerIndex));
          div.querySelector(".answersContainer").appendChild(ansDiv);
        };

        container.appendChild(div);
        roundCount++;
      });
    }

    // --- Render Fast Money rounds ---
    function renderFastMoneyRounds(fastMoneyRounds) {
      const container = document.getElementById("fastMoneyContainer");
      container.innerHTML = "";
      fastMoneyCount = 0;

      fastMoneyRounds.forEach((fmRound, fmIndex) => {
        const div = document.createElement("div");
        div.className = "mb-10 p-4 border rounded bg-white";

        div.innerHTML = `
          <h3 class="text-lg font-bold mb-4">Fast Money Round ${fmIndex + 1}</h3>
          <div class="flex gap-6">
            <div class="flex flex-col gap-2 w-1/3">
              <label class="font-semibold mb-1">Contestant Answers</label>
            </div>
            <div class="flex flex-col gap-2 w-2/3">
              <label class="font-semibold mb-1">Top Answers (max 6)</label>
            </div>
          </div>
        `;

        const contestantDiv = document.createElement("div");
        contestantDiv.className = "flex flex-col gap-2 w-1/3";

        const topAnswersDiv = document.createElement("div");
        topAnswersDiv.className = "flex flex-col gap-2 w-2/3";

        // Add 5 contestant answer inputs
        for (let i = 0; i < 5; i++) {
          const val = fmRound.contestantAnswers?.[i] || "";
          const ansInput = document.createElement("input");
          ansInput.type = "text";
          ansInput.placeholder = `Answer ${i + 1}`;
          ansInput.className = "p-2 border rounded";
          ansInput.value = val;
          ansInput.dataset.idx = i;
          contestantDiv.appendChild(ansInput);
        }

        // Add up to 6 top answers with points and reveal buttons
        for (let i = 0; i < 6; i++) {
          const answerObj = fmRound.topAnswers?.[i] || { text: "", points: 0, revealedAnswer: false, revealedPoints: false };

          const ansContainer = document.createElement("div");
          ansContainer.className = "flex items-center gap-2";

          const leftAnswer = document.createElement("input");
          leftAnswer.type = "text";
          leftAnswer.placeholder = `Top Answer ${i + 1}`;
          leftAnswer.className = "p-2 border rounded flex-1";
          leftAnswer.value = answerObj.text;

          const pointsInput = document.createElement("input");
          pointsInput.type = "number";
          pointsInput.placeholder = "Points";
          pointsInput.className = "p-2 border rounded w-20";

          pointsInput.value = answerObj.points;

          // Reveal buttons for contestant answer and points
          const revealAnswerBtn = document.createElement("button");
          revealAnswerBtn.className = "bg-yellow-500 text-white px-2 py-1 rounded";
          revealAnswerBtn.textContent = "Reveal Answer";

          const revealPointsBtn = document.createElement("button");
          revealPointsBtn.className = "bg-yellow-600 text-white px-2 py-1 rounded ml-2";
          revealPointsBtn.textContent = "Reveal Points";

          ansContainer.appendChild(leftAnswer);
          ansContainer.appendChild(pointsInput);
          ansContainer.appendChild(revealAnswerBtn);
          ansContainer.appendChild(revealPointsBtn);

          // Store data-index for event handlers
          revealAnswerBtn.dataset.fmIndex = fmIndex;
          revealAnswerBtn.dataset.answerIndex = i;
          revealPointsBtn.dataset.fmIndex = fmIndex;
          revealPointsBtn.dataset.answerIndex = i;

          revealAnswerBtn.onclick = () => revealFastMoneyAnswer(fmIndex, i);
          revealPointsBtn.onclick = () => revealFastMoneyPoints(fmIndex, i);

          topAnswersDiv.appendChild(ansContainer);
        }

        // Append contestant and top answers side by side
        const flexContainer = div.querySelector("div.flex.gap-6");
        flexContainer.innerHTML = ""; // clear children inside the flex container
        flexContainer.appendChild(contestantDiv);
        flexContainer.appendChild(topAnswersDiv);

        container.appendChild(div);
        fastMoneyCount++;
      });
    }

    // --- Add new normal round ---
    window.addRound = function () {
      const container = document.getElementById("roundsContainer");
      const div = document.createElement("div");
      div.className = "mb-8 p-4 border rounded bg-white";
      div.innerHTML = `
        <h2 class="text-xl font-bold mb-2">Round ${roundCount + 1}</h2>
        <div class="mb-2">
          <label class="block mb-1 font-semibold">Question:</label>
          <input type="text" class="questionInput w-full p-2 border rounded" value="">
        </div>
        <div class="answersContainer"></div>
        <button class="addAnswerBtn mt-2 px-3 py-1 bg-blue-500 text-white rounded">Add Answer</button>
      `;

      const answersContainer = div.querySelector(".answersContainer");

      const addAnswerBtn = div.querySelector(".addAnswerBtn");
      addAnswerBtn.onclick = () => {
        const answerIndex = answersContainer.children.length;
        const ansDiv = createAnswerInput("", "", () => revealAnswer(roundCount, answerIndex));
        answersContainer.appendChild(ansDiv);
      };

      container.appendChild(div);
      roundCount++;

      updateRoundLabels();
    };

    // --- Add new fast money round ---
    window.addFastMoneyRound = function () {
      const container = document.getElementById("fastMoneyContainer");
      const div = document.createElement("div");
      div.className = "mb-10 p-4 border rounded bg-white";

      div.innerHTML = `
        <h3 class="text-lg font-bold mb-4">Fast Money Round ${fastMoneyCount + 1}</h3>
        <div class="flex gap-6">
          <div class="flex flex-col gap-2 w-1/3">
            <label class="font-semibold mb-1">Contestant Answers</label>
          </div>
          <div class="flex flex-col gap-2 w-2/3">
            <label class="font-semibold mb-1">Top Answers (max 6)</label>
          </div>
        </div>
      `;

      const contestantDiv = document.createElement("div");
      contestantDiv.className = "flex flex-col gap-2 w-1/3";

      const topAnswersDiv = document.createElement("div");
      topAnswersDiv.className = "flex flex-col gap-2 w-2/3";

      // Add 5 empty contestant answer inputs
      for (let i = 0; i < 5; i++) {
        const ansInput = document.createElement("input");
        ansInput.type = "text";
        ansInput.placeholder = `Answer ${i + 1}`;
        ansInput.className = "p-2 border rounded";
        contestantDiv.appendChild(ansInput);
      }

      // Add 6 empty top answers with points and reveal buttons
      for (let i = 0; i < 6; i++) {
        const ansContainer = document.createElement("div");
        ansContainer.className = "flex items-center gap-2";

        const leftAnswer = document.createElement("input");
        leftAnswer.type = "text";
        leftAnswer.placeholder = `Top Answer ${i + 1}`;
        leftAnswer.className = "p-2 border rounded flex-1";

        const pointsInput = document.createElement("input");
        pointsInput.type = "number";
        pointsInput.placeholder = "Points";
        pointsInput.className = "p-2 border rounded w-20";

        const revealAnswerBtn = document.createElement("button");
        revealAnswerBtn.className = "bg-yellow-500 text-white px-2 py-1 rounded";
        revealAnswerBtn.textContent = "Reveal Answer";

        const revealPointsBtn = document.createElement("button");
        revealPointsBtn.className = "bg-yellow-600 text-white px-2 py-1 rounded ml-2";
        revealPointsBtn.textContent = "Reveal Points";

        ansContainer.appendChild(leftAnswer);
        ansContainer.appendChild(pointsInput);
        ansContainer.appendChild(revealAnswerBtn);
        ansContainer.appendChild(revealPointsBtn);

        // Assign dummy no-op handlers for now
        revealAnswerBtn.onclick = () => alert("Reveal answer functionality to implement.");
        revealPointsBtn.onclick = () => alert("Reveal points functionality to implement.");

        topAnswersDiv.appendChild(ansContainer);
      }

      const flexContainer = div.querySelector("div.flex.gap-6");
      flexContainer.innerHTML = ""; // clear children inside flex container
      flexContainer.appendChild(contestantDiv);
      flexContainer.appendChild(topAnswersDiv);

      container.appendChild(div);
      fastMoneyCount++;

      updateFastMoneyLabels();
    };

    // --- Update all normal round labels ---
    function updateRoundLabels() {
      const container = document.getElementById("roundsContainer");
      const rounds = container.querySelectorAll("div.mb-8");
      rounds.forEach((roundDiv, idx) => {
        const h2 = roundDiv.querySelector("h2");
        if (h2) h2.textContent = `Round ${idx + 1}`;
      });
      roundCount = rounds.length;
    }

    // --- Update all fast money round labels ---
    function updateFastMoneyLabels() {
      const container = document.getElementById("fastMoneyContainer");
      const rounds = container.querySelectorAll("div.mb-10");
      rounds.forEach((fmDiv, idx) => {
        const h3 = fmDiv.querySelector("h3");
        if (h3) h3.textContent = `Fast Money Round ${idx + 1}`;
      });
      fastMoneyCount = rounds.length;
    }

    // --- Start game: save all rounds and fast money rounds to Firebase ---
    window.startGame = function () {
      const rounds = [];
      const roundDivs = document.querySelectorAll("#roundsContainer > div");
      roundDivs.forEach(div => {
        const question = div.querySelector(".questionInput").value;
        const answerEls = div.querySelectorAll(".answerText");
        const pointEls = div.querySelectorAll(".answerPoints");
        const answers = [];
        answerEls.forEach((input, i) => {
          const text = input.value.trim();
          const points = parseInt(pointEls[i].value, 10);
          if (text && !isNaN(points)) answers.push({ text, points });
        });
        rounds.push({ question, answers, revealed: Array(answers.length).fill(false), strikes: 0 });
      });

      // Save fast money rounds
      const fastMoneyRounds = [];
      const fmDivs = document.querySelectorAll("#fastMoneyContainer > div");
      fmDivs.forEach(div => {
        // Contestant answers
        const contestantAnswers = Array.from(div.querySelectorAll("div.flex.flex-col.w-1\\/3 > input")).map(i => i.value.trim());
        // Top answers, points, revealed states
        const topAnswersDivs = div.querySelectorAll("div.flex.flex-col.w-2\\/3 > div");
        const topAnswers = [];
        topAnswersDivs.forEach(ansDiv => {
          const inputs = ansDiv.querySelectorAll("input");
          const text = inputs[0]?.value.trim() || "";
          const points = parseInt(inputs[1]?.value, 10) || 0;
          // We will store revealed flags in the game state as false initially
          topAnswers.push({ text, points, revealedAnswer: false, revealedPoints: false });
        });
        fastMoneyRounds.push({ contestantAnswers, topAnswers });
      });

      const gameData = {
        rounds,
        fastMoneyRounds,
        currentRoundIndex: 0,
        scoreA: 0,
        scoreB: 0,
      };

      const gameRef = ref(db, "game");
      set(gameRef, gameData)
        .then(() => {
          alert("Game saved and started!");
        })
        .catch(err => {
          alert("Error saving game: " + err.message);
        });
    };

    // --- Reveal normal round answer ---
    window.revealAnswer = function (roundIndex, answerIndex) {
      const gameRef = ref(db, "game");
      get(gameRef).then(snapshot => {
        const data = snapshot.val();
        if (!data) return;
        if (!data.rounds?.[roundIndex]?.revealed) data.rounds[roundIndex].revealed = [];
        data.rounds[roundIndex].revealed[answerIndex] = true;
        set(gameRef, data);
      });
    };

    // --- Reveal fast money answer ---
    function revealFastMoneyAnswer(fmIndex, answerIndex) {
      const gameRef = ref(db, "game");
      get(gameRef).then(snapshot => {
        const data = snapshot.val();
        if (!data) return;
        if (!data.fastMoneyRounds?.[fmIndex]?.topAnswers?.[answerIndex]) return;
        data.fastMoneyRounds[fmIndex].topAnswers[answerIndex].revealedAnswer = true;
        set(gameRef, data);
      });
    }

    // --- Reveal fast money points ---
    function revealFastMoneyPoints(fmIndex, answerIndex) {
      const gameRef = ref(db, "game");
      get(gameRef).then(snapshot => {
        const data = snapshot.val();
        if (!data) return;
        if (!data.fastMoneyRounds?.[fmIndex]?.topAnswers?.[answerIndex]) return;
        data.fastMoneyRounds[fmIndex].topAnswers[answerIndex].revealedPoints = true;
        set(gameRef, data);
      });
    }

    // --- Add strike ---
    window.addStrike = function () {
      const gameRef = ref(db, "game");
      get(gameRef).then(snapshot => {
        const data = snapshot.val();
        if (!data) return;
        const round = data.rounds[data.currentRoundIndex];
        if (!round) return;
        round.strikes = Math.min((round.strikes || 0) + 1, 3);
        data.rounds[data.currentRoundIndex] = round;
        set(gameRef, data);
      });
    };

    // --- Reset strikes ---
    window.resetStrikes = function () {
      const gameRef = ref(db, "game");
      get(gameRef).then(snapshot => {
        const data = snapshot.val();
        if (!data) return;
        if (data.rounds?.[data.currentRoundIndex]) {
          data.rounds[data.currentRoundIndex].strikes = 0;
          set(gameRef, data);
        }
      });
    };

    // --- Set team score ---
    window.setScore = function (team) {
      const inputId = team === "A" ? "scoreAInput" : "scoreBInput";
      const val = Number(document.getElementById(inputId).value);
      const scoreKey = team === "A" ? "scoreA" : "scoreB";
      const gameRef = ref(db, "game");
      get(gameRef).then(snapshot => {
        const data = snapshot.val() || {};
        data[scoreKey] = val;
        set(gameRef, data);
      });
    };

    // --- Reset scores ---
    window.resetScores = function () {
      const gameRef = ref(db, "game");
      get(gameRef).then(snapshot => {
        const data = snapshot.val() || {};
        data.scoreA = 0;
        data.scoreB = 0;
        set(gameRef, data);
      });
    };

    // --- Next round ---
    window.nextRound = function () {
      const gameRef = ref(db, "game");
      get(gameRef).then(snapshot => {
        const data = snapshot.val();
        if (!data) return;
        if (data.currentRoundIndex < (data.rounds?.length ?? 0) - 1) {
          data.currentRoundIndex++;
          set(gameRef, data);
        }
      });
    };

    // --- Load saved game data ---
    window.addEventListener("DOMContentLoaded", () => {
      const gameRef = ref(db, "game");
      get(gameRef).then(snapshot => {
        const data = snapshot.val();
        if (data?.rounds?.length) renderSavedRounds(data.rounds);
        if (data?.fastMoneyRounds?.length) renderFastMoneyRounds(data.fastMoneyRounds);
      });
    });
  </script>
</body>
</html>
