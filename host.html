<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Family Feud Host</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
  <h1 class="text-3xl font-bold mb-6">🎮 Host Panel</h1>

  <!-- Normal Rounds -->
  <div id="roundsContainer"></div>
  <button onclick="addRound()" class="mb-6 px-4 py-2 bg-blue-600 text-white rounded">Add Round</button>

  <hr class="my-8" />

  <!-- Fast Money Rounds -->
  <h2 class="text-2xl font-bold mb-4">⚡ Fast Money Rounds</h2>
  <div id="fastMoneyContainer"></div>
  <button onclick="addFastMoneyRound()" class="mt-4 px-4 py-2 bg-purple-600 text-white rounded">Add Fast Money Round</button>
  <button onclick="saveFastMoneyData()" class="px-4 py-2 bg-teal-600 text-white rounded">💾 Save Fast Money</button>
  <hr class="my-8" />

  <!-- Controls -->
  <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
    <button onclick="startGame()" class="px-4 py-2 bg-green-600 text-white rounded">Start Game</button>
    <button onclick="addStrike()" class="px-4 py-2 bg-red-500 text-white rounded">Add Strike</button>
    <button onclick="resetStrikes()" class="px-4 py-2 bg-gray-700 text-white rounded">Reset Strikes</button>
    <button onclick="nextRound()" class="px-4 py-2 bg-indigo-600 text-white rounded">Next Round</button>
  </div>
  
  <!-- Score Controls -->
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
    <div class="flex items-center gap-2">
      <input type="number" id="scoreAInput" placeholder="Team A score" class="p-2 border rounded w-full" />
      <button onclick="setScore('A')" class="px-4 py-2 bg-yellow-500 text-white rounded">Set Team A</button>
    </div>
    <div class="flex items-center gap-2">
      <input type="number" id="scoreBInput" placeholder="Team B score" class="p-2 border rounded w-full" />
      <button onclick="setScore('B')" class="px-4 py-2 bg-yellow-600 text-white rounded">Set Team B</button>
    </div>
    <div class="flex items-center justify-start sm:justify-end">
      <button onclick="resetScores()" class="px-4 py-2 bg-gray-700 text-white rounded w-full sm:w-auto">Reset Scores</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCS99cX6swqx4--HiWD_kDh1cZVFXc2KfE",
      authDomain: "family-feud-game-13f89.firebaseapp.com",
      projectId: "family-feud-game-13f89",
      storageBucket: "family-feud-game-13f89.appspot.com",
      messagingSenderId: "911043163745",
      appId: "1:911043163745:web:dce176591585a093a21c20",
      measurementId: "G-Q2S4LXF4XM",
      databaseURL: "https://family-feud-game-13f89-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let roundCount = 0;
    let fastMoneyCount = 0;

    // Helper to create answer input for normal rounds
    function createAnswerInput(answer = "", points = 0, revealCallback = null) {
      const div = document.createElement("div");
      div.className = "flex items-center gap-2 mb-2";
      div.innerHTML = `
        <input type="text" placeholder="Answer" class="answerText p-2 border rounded w-2/5" value="${answer}">
        <input type="number" placeholder="Points" class="answerPoints p-2 border rounded w-1/5" value="${points}">
        <button class="revealBtn bg-yellow-500 text-white px-2 py-1 rounded">Reveal</button>
      `;
      if (revealCallback) {
        div.querySelector(".revealBtn").onclick = revealCallback;
      }
      return div;
    }

    // Render normal rounds
    function renderSavedRounds(rounds =[]) {
      if (!Array.isArray(rounds)) return;
      
      const container = document.getElementById("roundsContainer");
      container.innerHTML = "";
      roundCount = 0;

      rounds.forEach((round, roundIndex) => {
        const div = document.createElement("div");
        div.className = "mb-8 p-4 border rounded bg-white";
        div.innerHTML = `
          <h2 class="text-xl font-bold mb-2">Round ${roundIndex + 1}</h2>
          <div class="mb-2">
            <label class="block mb-1 font-semibold">Question:</label>
            <input type="text" class="questionInput w-full p-2 border rounded" value="${round.question || ''}">
          </div>
          <div class="answersContainer"></div>
          <button class="addAnswerBtn mt-2 px-3 py-1 bg-blue-500 text-white rounded">Add Answer</button>
        `;

        const answersContainer = div.querySelector(".answersContainer");
        round.answers.forEach((answer, answerIndex) => {
          const ansDiv = createAnswerInput(answer.text, answer.points, () => revealAnswer(roundIndex, answerIndex));
          answersContainer.appendChild(ansDiv);
        });

        div.querySelector(".addAnswerBtn").onclick = () => {
          const answerIndex = div.querySelector(".answersContainer").children.length;
          const ansDiv = createAnswerInput("", 0, () => revealAnswer(roundIndex, answerIndex));
          div.querySelector(".answersContainer").appendChild(ansDiv);
        };

        container.appendChild(div);
        roundCount++;
      });
    }

    // Render fast money rounds
    window.saveFastMoneyData = function () {
      const rounds = [];
      const fmDivs = document.querySelectorAll("#fastMoneyContainer > div");
    
      fmDivs.forEach(div => {
        const questionRows = div.querySelectorAll(".flex.gap-4.items-start");
        const questions = [];
    
        questionRows.forEach(row => {
          const question = row.querySelector("input[placeholder^='Question']")?.value || "";
    
          const contestantAnswer1 = row.querySelector("input[placeholder='Contestant Answer 1']")?.value || "";
          const contestantPoints1 = parseInt(row.querySelector("input[placeholder='Pts 1']")?.value || "0", 10);
    
          const contestantAnswer2 = row.querySelector("input[placeholder='Contestant Answer 2']")?.value || "";
          const contestantPoints2 = parseInt(row.querySelector("input[placeholder='Pts 2']")?.value || "0", 10);
    
          const topAnswers = Array.from(row.querySelectorAll("input[placeholder^='Top Answer']")).map((input, idx) => {
            const pointsInput = row.querySelectorAll("input[placeholder='Pts']")[idx];
            return {
              text: input.value,
              points: parseInt(pointsInput?.value || "0", 10)
            };
          });
    
          questions.push({
            question,
            contestantAnswer1,
            contestantPoints1,
            contestantAnswer2,
            contestantPoints2,
            topAnswers
          });
        });
    
        rounds.push({ questions });
      });
    
      const dbRef = firebase.database().ref("fastMoneyRounds");
      dbRef.set(rounds).then(() => {
        alert("✅ Fast Money data saved!");
        console.log("%c✅ Fast Money data saved!", "color: green; font-weight: bold;");
      }).catch(err => {
        console.error("Error saving Fast Money data:", err);
        alert("❌ Failed to save Fast Money data.");
      });
    };

    function loadFastMoneyData() {
      const refPath = ref(db, "fastMoneyRounds");
      get(refPath).then(snapshot => {
        const data = snapshot.val();
        if (Array.isArray(data)) {
          data.forEach(round => {
            if (round && Array.isArray(round.questions)) {
              addFastMoneyRound(round);
            }
          });
        } else {
          console.warn("No fast money data found or data is malformed:", data);
        }
      }).catch(error => {
        console.error("Failed to load fast money data:", error);
      });
    }
    
    window.addFastMoneyRound = function (prefill = null) {
      const container = document.getElementById("fastMoneyContainer");
      const div = document.createElement("div");
      div.className = "mb-10 p-4 border rounded bg-white";

      div.innerHTML = `
        <h3 class="text-lg font-bold mb-4">Fast Money Round ${fastMoneyCount + 1}</h3>
        <div class="flex flex-col gap-6"></div>
      `;

      const content = div.querySelector(".flex.flex-col.gap-6");

    for (let i = 0; i < 5; i++) {
      const row = document.createElement("div");
      row.className = "flex gap-4 items-start w-full";
    
      const leftCol = document.createElement("div");
      leftCol.className = "w-1/3 flex flex-col gap-2";
    
      const currentQuestion = prefill?.questions?.[i] || {};
    
      const qInput = document.createElement("input");
      qInput.type = "text";
      qInput.placeholder = `Question ${i + 1}`;
      qInput.className = "p-2 border rounded w-full text-sm";
      qInput.value = currentQuestion.question || "";

      const answerRow1 = document.createElement("div");
      answerRow1.className = "flex gap-2 items-center";
    
      const aInput1 = document.createElement("input");
      aInput1.type = "text";
      aInput1.placeholder = "Contestant Answer 1";
      aInput1.className = "p-1 border rounded w-4/5 text-sm";
      aInput1.value = currentQuestion.contestantAnswer1 || "";
    
      const ptsInput1 = document.createElement("input");
      ptsInput1.type = "number";
      ptsInput1.placeholder = "Pts 1";
      ptsInput1.className = "p-1 border rounded w-1/5 text-sm";
      ptsInput1.value = currentQuestion.contestantPoints1 || "";

      answerRow1.appendChild(aInput1);
      answerRow1.appendChild(ptsInput1);

      const answerRow2 = document.createElement("div");
      answerRow2.className = "flex gap-2 items-center";
    
      const aInput2 = document.createElement("input");
      aInput2.type = "text";
      aInput2.placeholder = "Contestant Answer 2";
      aInput2.className = "p-1 border rounded w-4/5 text-sm";
      aInput2.value = currentQuestion.contestantAnswer2 || "";
    
      const ptsInput2 = document.createElement("input");
      ptsInput2.type = "number";
      ptsInput2.placeholder = "Pts 2";
      ptsInput2.className = "p-1 border rounded w-1/5 text-sm";
      ptsInput2.value = currentQuestion.contestantPoints2 || "";

      answerRow2.appendChild(aInput2);
      answerRow2.appendChild(ptsInput2);
    
      const revealAnswerBtn = document.createElement("button");
      revealAnswerBtn.className = "bg-yellow-500 text-white px-2 py-1 rounded text-sm w-full";
      revealAnswerBtn.textContent = `Reveal Answers`;
  
      const revealPointsBtn = document.createElement("button");
      revealPointsBtn.className = "bg-yellow-600 text-white px-2 py-1 rounded text-sm w-full";
      revealPointsBtn.textContent = `Reveal Points`;
  
      leftCol.appendChild(qInput);
      leftCol.appendChild(answerRow1);
      leftCol.appendChild(answerRow2);
      leftCol.appendChild(revealAnswerBtn);
      leftCol.appendChild(revealPointsBtn);
  
      const rightCol = document.createElement("div");
      rightCol.className = "w-2/3 flex flex-col gap-2";
    
      const topAnswersWrap = document.createElement("div");
      topAnswersWrap.className = "flex flex-wrap gap-2 w-full";

        for (let j = 0; j < 5; j++) {
          const ansWrap = document.createElement("div");
          ansWrap.className = "w-[18%] bg-gray-50 p-2 rounded border flex flex-col gap-1";
      
          const topAnswer = currentQuestion.topAnswers?.[j] || {};
      
          const ansInput = document.createElement("input");
          ansInput.type = "text";
          ansInput.placeholder = `Top Answer ${j + 1}`;
          ansInput.className = "p-1 border rounded text-sm";
          ansInput.value = topAnswer.text || "";
      
          const ptsInput = document.createElement("input");
          ptsInput.type = "number";
          ptsInput.placeholder = "Pts";
          ptsInput.className = "p-1 border rounded text-sm";
          ptsInput.value = topAnswer.points || "";
      
          ansWrap.appendChild(ansInput);
          ansWrap.appendChild(ptsInput);
          topAnswersWrap.appendChild(ansWrap);
        }

        const revealTopBtn = document.createElement("button");
        revealTopBtn.className = "bg-yellow-700 text-white px-2 py-1 rounded text-sm w-full";
        revealTopBtn.textContent = "Reveal Top Answers";

        rightCol.appendChild(topAnswersWrap);
        rightCol.appendChild(revealTopBtn);

        row.appendChild(leftCol);
        row.appendChild(rightCol);
        content.appendChild(row);
      }

      container.appendChild(div);
      fastMoneyCount++;
    };
    
    // Update round labels after adding/removing rounds
    function updateRoundLabels() {
      const roundDivs = document.querySelectorAll("#roundsContainer > div");
      roundDivs.forEach((div, i) => {
        const h2 = div.querySelector("h2");
        if (h2) h2.textContent = `Round ${i + 1}`;
      });
      roundCount = roundDivs.length;
    }

    // Update fast money round labels
    function updateFastMoneyLabels() {
      const fmDivs = document.querySelectorAll("#fastMoneyContainer > div");
      fmDivs.forEach((div, i) => {
        const h3 = div.querySelector("h3");
        if (h3) h3.textContent = `Fast Money Round ${i + 1}`;
      });
      fastMoneyCount = fmDivs.length;
    }

    // --- Reveal normal round answer ---
    function revealAnswer(roundIndex, answerIndex) {
      const gameRef = ref(db, "game");
      get(gameRef).then(snapshot => {
        const data = snapshot.val() || {};
        if (!data.rounds?.[roundIndex]) return;
        if (!data.rounds[roundIndex].revealed) data.rounds[roundIndex].revealed = [];
        data.rounds[roundIndex].revealed[answerIndex] = true;
        set(gameRef, data);
      });
    }

    // --- Reveal fast money answer ---
    function revealFastMoneyAnswer(fmIndex, answerIndex) {
      const gameRef = ref(db, "game");
      get(gameRef).then(snapshot => {
        const data = snapshot.val() || {};
        if (!data.fastMoneyRounds?.[fmIndex]?.topAnswers?.[answerIndex]) return;
        if (!data.fastMoneyRounds[fmIndex].topAnswers[answerIndex].revealedAnswer) {
          data.fastMoneyRounds[fmIndex].topAnswers[answerIndex].revealedAnswer = true;
          set(gameRef, data);
        }
      });
    }

    // --- Reveal fast money points ---
    function revealFastMoneyPoints(fmIndex, answerIndex) {
      const gameRef = ref(db, "game");
      get(gameRef).then(snapshot => {
        const data = snapshot.val() || {};
        if (!data.fastMoneyRounds?.[fmIndex]?.topAnswers?.[answerIndex]) return;
        if (!data.fastMoneyRounds[fmIndex].topAnswers[answerIndex].revealedPoints) {
          data.fastMoneyRounds[fmIndex].topAnswers[answerIndex].revealedPoints = true;
          set(gameRef, data);
        }
      });
    }

    // --- Add strike ---
    window.addStrike = function () {
      const gameRef = ref(db, "game");
      get(gameRef).then(snapshot => {
        const data = snapshot.val() || {};
        const round = data.rounds?.[data.currentRoundIndex];
        if (!round) return;
        round.strikes = Math.min((round.strikes || 0) + 1, 3);
        data.rounds[data.currentRoundIndex] = round;
        set(gameRef, data);
      });
    };

    // --- Reset strikes ---
    window.resetStrikes = function () {
      const gameRef = ref(db, "game");
      get(gameRef).then(snapshot => {
        const data = snapshot.val() || {};
        if (data.rounds?.[data.currentRoundIndex]) {
          data.rounds[data.currentRoundIndex].strikes = 0;
          set(gameRef, data);
        }
      });
    };

    // --- Set team score ---
    window.setScore = function (team) {
      const inputId = team === "A" ? "scoreAInput" : "scoreBInput";
      const val = Number(document.getElementById(inputId).value);
      const scoreKey = team === "A" ? "scoreA" : "scoreB";
      const gameRef = ref(db, "game");
      get(gameRef).then(snapshot => {
        const data = snapshot.val() || {};
        data[scoreKey] = val;
        set(gameRef, data);
      });
    };

    // --- Reset scores ---
    window.resetScores = function () {
      const gameRef = ref(db, "game");
      get(gameRef).then(snapshot => {
        const data = snapshot.val() || {};
        data.scoreA = 0;
        data.scoreB = 0;
        set(gameRef, data);
      });
    };

    // --- Next round ---
    window.nextRound = function () {
      const gameRef = ref(db, "game");
      get(gameRef).then(snapshot => {
        const data = snapshot.val() || {};
        if (data.currentRoundIndex < (data.rounds?.length ?? 0) - 1) {
          data.currentRoundIndex++;
          set(gameRef, data);
        }
      });
    };

    // --- Start game ---
    window.startGame = function () {
      // Collect normal rounds data
      const rounds = [];
      const roundDivs = document.querySelectorAll("#roundsContainer > div");
      roundDivs.forEach((div, roundIndex) => {
        const question = div.querySelector(".questionInput").value;
        const answerEls = div.querySelectorAll(".answerText");
        const pointEls = div.querySelectorAll(".answerPoints");
        const answers = [];

        answerEls.forEach((input, i) => {
          const text = input.value.trim();
          const points = parseInt(pointEls[i].value, 10);
          if (text && !isNaN(points)) {
            answers.push({ text, points });
          }
        });

        rounds.push({ question, answers, revealed: Array(answers.length).fill(false), strikes: 0 });
      });

      // Collect fast money rounds data
      const fastMoneyRounds = [];
      const fmDivs = document.querySelectorAll("#fastMoneyContainer > div");
      fmDivs.forEach(div => {
        const contestantAnswers = Array.from(div.querySelectorAll("#contestantAnswersCol > input")).map(input => input.value.trim());
        const topAnswerDivs = div.querySelectorAll("#topAnswersCol > div");
        const topAnswers = Array.from(topAnswerDivs).map(topDiv => {
          const inputs = topDiv.querySelectorAll("input");
          return {
            text: inputs[0].value.trim(),
            points: parseInt(inputs[1].value, 10) || 0,
            revealedAnswer: false,
            revealedPoints: false
          };
        });
        fastMoneyRounds.push({ contestantAnswers, topAnswers });
      });

      const gameRef = ref(db, "game");
      set(gameRef, {
        rounds,
        fastMoneyRounds,
        currentRoundIndex: 0,
        scoreA: 0,
        scoreB: 0
      });
    };

    // Load saved data on page load
    window.addEventListener("DOMContentLoaded", () => {
      const gameRef = ref(db, "game");
      get(gameRef).then(snapshot => {
        const data = snapshot.val();
        if (data?.rounds?.length) renderSavedRounds(data.rounds);
        if (data?.fastMoneyRounds?.length) renderFastMoneyRounds(data.fastMoneyRounds);
      });
    });
  </script>
</body>
</html>
