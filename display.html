<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Family Feud Display</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* Custom styles for the fast money timer, etc. */
        /* .fast-money-timer styles removed as per user request */
        .fast-money-score {
            font-size: 4rem;
            font-weight: bold;
            color: #ADD8E6; /* Light Blue */
            text-shadow: 3px 3px 5px rgba(0,0,0,0.6);
        }
        /* Custom styles for consistent answer box size */
        .answer-box-base {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fbbf24; /* bg-yellow-400 */
            border-radius: 0.375rem; /* rounded-md */
            margin-bottom: 0.5rem; /* mb-2 */
            padding: 0.75rem; /* p-3 */
            /* --- IMPORTANT CHANGES HERE --- */
            height: 60px; /* Set a fixed height */
            box-sizing: border-box; /* Ensures padding/border are included in total width/height */
            overflow: hidden; /* Prevent content from pushing the box larger if it's too long */
        }
        .answer-box-blank {
            background-color: #fbbf24; /* bg-yellow-400 */
            border-radius: 0.375rem; /* rounded-md */
            margin-bottom: 0.5rem; /* mb-2 */
            padding: 0.75rem; /* p-3 */
            /* --- IMPORTANT CHANGES HERE --- */
            height: 60px; /* Match the fixed height */
            display: flex; /* Make it a flex container to align the number circle if used */
            justify-content: center; /* Center horizontally if content is added later */
            align-items: center; /* Center vertically */
            box-sizing: border-box;
        }
        /* Centering the number circle content */
        .answer-number-circle {
            display: flex;
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
            width: 40px; /* w-10 */
            height: 40px; /* h-10 */
            border-radius: 9999px; /* rounded-full */
            border-width: 4px; /* border-4 */
            border-color: #000; /* border-black */
            background-color: #fcd34d; /* bg-yellow-200 */
            color: #000; /* text-black */
            font-weight: bold; /* font-bold */
            font-size: 1.25rem; /* text-xl */
            user-select: none; /* select-none */
            /* --- IMPORTANT: Ensure text within answer box stays in one line --- */
            white-space: nowrap; /* Prevent text wrapping inside the revealed answer */
        }
       
        /* Add this rule to prevent long answers from wrapping and increasing box height */
        .answer-box-base .text-black {
            white-space: nowrap; /* Keep answer text on a single line */
            overflow: hidden; /* Hide any overflow if text is too long */
            text-overflow: ellipsis; /* Add "..." for truncated text */
        }

        /* New Fast Money specific styles for team scores */
        .fast-money-score-display {
            font-size: 4rem;
            font-weight: bold;
            color: #ADD8E6; /* Light Blue */
            text-shadow: 3px 3px 5px rgba(0,0,0,0.6);
            display: flex; /* Use flexbox for horizontal alignment */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
            gap: 40px; /* Space between the two score displays */
            margin-top: 20px; /* Add some margin above */
            margin-bottom: 20px; /* Margin below for total score */
        }
        .fast-money-score-item {
            text-align: center;
        }
        .fast-money-score-item h2 {
            font-size: 1.5rem; /* Smaller heading for "Team A / Team B" */
            font-weight: bold;
            color: #ADD8E6; /* Light Blue */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 5px;
        }
    </style>
</head>
<body class="bg-blue-900 text-white min-h-screen flex flex-col items-center p-8 select-none">
    <div id="audioUnlockOverlay" class="fixed inset-0 bg-blue-900 bg-opacity-95 flex items-center justify-center z-50">
        <button id="startButton" class="bg-yellow-500 text-blue-900 text-3xl font-bold px-10 py-5 rounded-lg shadow-xl hover:bg-yellow-400 transform hover:scale-105 transition-transform duration-200">
            Click to Start Game
        </button>
    </div>

    <h1 class="text-4xl font-bold mb-2">üéâ Family Feud üéâ</h1>
    <div id="roundNumber" class="text-xl font-semibold mb-4">Waiting for game to start...</div>

    <div id="mainGameArea" class="max-w-5xl w-full">
        <div id="normalRoundUI" class="flex flex-col items-center">
            <div id="question" class="text-3xl font-semibold text-center mb-8">Waiting for host...</div>
            <div id="answers" class="max-w-5xl w-full mb-8"></div>

            <div class="flex gap-20 text-center text-2xl mb-8">
                <div>
                    <h2 class="font-bold">Team A</h2>
                    <div id="scoreA">0</div>
                </div>
                <div>
                    <h2 class="font-bold">Team B</h2>
                    <div id="scoreB">0</div>
                </div>
            </div>

            <div class="flex gap-4 text-4xl mb-8 select-none">
                <span id="strike1" class="transition-opacity duration-300">‚ùå</span>
                <span id="strike2" class="transition-opacity duration-300">‚ùå</span>
                <span id="strike3" class="transition-opacity duration-300">‚ùå</span>
            </div>
        </div>

        <div id="fastMoneyUI" class="hidden flex-col items-center w-full">
            <h2 class="text-5xl font-bold mb-8 text-yellow-400">‚ö° Fast Money! ‚ö°</h2>

            <div id="fastMoneyAnswersContainer" class="grid grid-cols-2 gap-4 w-full">
                </div>

            <div class="fast-money-score-display">
                <div class="fast-money-score-item">
                    <h2>Team A</h2>
                    <div id="fastMoneyScoreA">0</div>
                </div>
                <div class="fast-money-score-item">
                    <h2>Team B</h2>
                    <div id="fastMoneyScoreB">0</div>
                </div>
            </div>

            <div class="fast-money-score">Total: <span id="fastMoneyTotalScore">0</span></div>
        </div>
    </div>

    <audio id="introSound" src="intro.mp3" preload="auto"></audio>
    <audio id="dingSound" src="ding.mp3" preload="auto"></audio>
    <audio id="buzzSound" src="buzz.mp3" preload="auto"></audio>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getDatabase, ref, onValue, off } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCS99cX6swqx4--HiWD_kDh1cZVFXc2KfE",
            authDomain: "family-feud-game-13f89.firebaseapp.com",
            projectId: "family-feud-game-13f89",
            storageBucket: "family-feud-game-13f89.appspot.com",
            messagingSenderId: "911043163745",
            appId: "1:911043163745:web:dce176591585a093a21c20",
            measurementId: "G-Q2S4LXF4XM",
            databaseURL: "https://family-feud-game-13f89-default-rtdb.firebaseio.com/"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // References to UI elements
        const roundNumberEl = document.getElementById('roundNumber');
        const questionEl = document.getElementById('question');
        const answersContainer = document.getElementById('answers');
        const scoreAEl = document.getElementById('scoreA'); // Used for Normal Round Team A score
        const scoreBEl = document.getElementById('scoreB'); // Used for Normal Round Team B score
        const normalRoundUI = document.getElementById('normalRoundUI');
        const fastMoneyUI = document.getElementById('fastMoneyUI');
        const fastMoneyAnswersContainer = document.getElementById('fastMoneyAnswersContainer');
        // Removed fastMoneyTimerEl as it's no longer needed in HTML or JS
        const fastMoneyTotalScoreEl = document.getElementById('fastMoneyTotalScore'); // Total FM score
        // New: Fast Money Team Scores
        const fastMoneyScoreAEl = document.getElementById('fastMoneyScoreA');
        const fastMoneyScoreBEl = document.getElementById('fastMoneyScoreB');


        // Audio elements
        const introSound = document.getElementById('introSound');
        const dingSound = document.getElementById('dingSound');
        const buzzSound = document.getElementById('buzzSound');

        // Audio Unlock Overlay elements
        const audioUnlockOverlay = document.getElementById('audioUnlockOverlay');
        const startButton = document.getElementById('startButton');

        let activeGameRef = null;
        let previousRevealedState = [];
        let previousStrikes = 0;
        let currentActiveGameName = null;

        // --- Audio Functions ---
        function playIntro() {
            introSound.currentTime = 0;
            introSound.play().catch(e => console.warn("Intro sound play failed:", e));
        }
        
        function playDing() {
            dingSound.currentTime = 0;
            dingSound.play().catch(e => console.warn("Ding sound play failed:", e));
        }

        function playBuzz() {
            buzzSound.currentTime = 0;
            buzzSound.play().catch(e => console.warn("Buzz sound play failed:", e));
        }

        // --- Helper: Normal Round Answer Box Creation ---
        function createAnswerBox(number, answer, revealed, points) {
            const container = document.createElement('div');
            container.className = 'answer-box-base'; // Uses CSS for fixed height

            const leftDiv = document.createElement('div');
            leftDiv.className = 'flex items-center flex-1';

            if (revealed) {
                const answerText = document.createElement('span');
                answerText.className = 'text-black text-xl font-semibold truncate'; // truncate handled by CSS
                answerText.textContent = answer;
                leftDiv.appendChild(answerText);
            } else {
                const circle = document.createElement('div');
                circle.className = 'answer-number-circle'; // Uses CSS for centering
                circle.textContent = number;
                leftDiv.appendChild(circle);
            }
            container.appendChild(leftDiv);

            const pointsDiv = document.createElement('div');
            pointsDiv.className = 'bg-yellow-600 text-black font-bold text-xl px-4 py-1 rounded ml-4 min-w-[70px] text-center select-none';

            if (revealed) {
                pointsDiv.textContent = points + '';
            } else {
                pointsDiv.textContent = '';
            }
            container.appendChild(pointsDiv);

            return container;
        }

        // --- Helper: Fast Money Answer Box Creation ---
        function createFastMoneyAnswerBox(questionData, answerIndex) {
            const answer = questionData.topAnswers[answerIndex];
            if (!answer) return null;

            const container = document.createElement('div');
            container.className = 'flex flex-col bg-blue-700 p-4 rounded-lg shadow-lg';

            const questionTextEl = document.createElement('p');
            questionTextEl.className = 'text-lg font-semibold mb-2 text-yellow-300';
            questionTextEl.textContent = `${answerIndex + 1}. ${questionData.question}`;
            container.appendChild(questionTextEl);

            // Contestant Answers and Points
            const contestantAnswersDiv = document.createElement('div');
            contestantAnswersDiv.className = 'mb-4';

            const contestant1Div = document.createElement('div');
            contestant1Div.className = 'flex justify-between items-center bg-blue-800 p-2 rounded-md mb-2';
            contestant1Div.innerHTML = `
                <span class="text-white text-md">${questionData.revealedContestantAnswer1 ? questionData.contestantAnswer1 : '????'}</span>
                <span class="text-yellow-400 font-bold">${questionData.revealedContestantPoints1 ? questionData.contestantPoints1 : '--'}</span>
            `;
            contestantAnswersDiv.appendChild(contestant1Div);

            const contestant2Div = document.createElement('div');
            contestant2Div.className = 'flex justify-between items-center bg-blue-800 p-2 rounded-md';
            contestant2Div.innerHTML = `
                <span class="text-white text-md">${questionData.revealedContestantAnswer2 ? questionData.contestantAnswer2 : '????'}</span>
                <span class="text-yellow-400 font-bold">${questionData.revealedContestantPoints2 ? questionData.contestantPoints2 : '--'}</span>
            `;
            contestantAnswersDiv.appendChild(contestant2Div);

            container.appendChild(contestantAnswersDiv);

            // Top Answers Section
            const topAnswersDiv = document.createElement('div');
            topAnswersDiv.className = 'flex flex-col gap-2';

            questionData.topAnswers.forEach((topAns, idx) => {
                const topAnsRow = document.createElement('div');
                topAnsRow.className = 'flex justify-between items-center bg-yellow-400 p-2 rounded-md';
                topAnsRow.innerHTML = `
                    <span class="text-black font-semibold">${topAns.revealedAnswer ? topAns.text : '????'}</span>
                    <span class="bg-yellow-600 text-black font-bold px-2 py-0.5 rounded">${topAns.revealedPoints ? topAns.points : '--'}</span>
                `;
                topAnswersDiv.appendChild(topAnsRow);
            });
            container.appendChild(topAnswersDiv);

            return container;
        }

        // --- Main Update Display Function ---
        function updateDisplay(data) {
            const currentRoundIndex = data.currentRoundIndex;

            if (currentRoundIndex === "fastMoney") {
                normalRoundUI.classList.add('hidden');
                normalRoundUI.classList.remove('flex');
                fastMoneyUI.classList.remove('hidden');
                fastMoneyUI.classList.add('flex');
                displayFastMoneyRound(data);
            } else if (currentRoundIndex === "gameOver") {
                 normalRoundUI.classList.remove('hidden');
                 normalRoundUI.classList.add('flex');
                 fastMoneyUI.classList.add('hidden');
                 fastMoneyUI.classList.remove('flex');
                 roundNumberEl.textContent = "Game Over!";
                 questionEl.textContent = "Thank you for playing!";
                 answersContainer.innerHTML = '';
            }
            else {
                normalRoundUI.classList.remove('hidden');
                normalRoundUI.classList.add('flex');
                fastMoneyUI.classList.add('hidden');
                fastMoneyUI.classList.remove('flex');
                displayNormalRound(data);
            }
        }

        // --- Display Normal Round Logic ---
        function displayNormalRound(data) {
            const rounds = Array.isArray(data.rounds) ? data.rounds : [];
            const currentIndex = typeof data.currentRoundIndex === 'number' ? data.currentRoundIndex : 0;
            const currentRound = rounds[currentIndex] || { question: 'Waiting for host...', answers: [], revealed: [], strikes: 0 };

            questionEl.textContent = currentRound.question || 'Waiting for host...';
            answersContainer.innerHTML = '';

            const maxSlots = 8;
            const col1Count = 4;

            const colsWrapper = document.createElement('div');
            colsWrapper.className = 'flex gap-4 max-w-5xl w-full';

            const col1 = document.createElement('div');
            col1.className = 'flex flex-col flex-1 gap-2';
            const col2 = document.createElement('div');
            col2.className = 'flex flex-col flex-1 gap-2';

            let currentRevealedState = [];

            for (let i = 0; i < maxSlots; i++) {
                const answerObj = currentRound.answers[i];
                const isRevealed = currentRound.revealed?.[i] || false;
                const number = i + 1;

                const col = i < col1Count ? col1 : col2;

                if (!answerObj) {
                    const blankBox = document.createElement('div');
                    blankBox.className = 'answer-box-blank'; // Uses CSS for fixed height
                    col.appendChild(blankBox);
                    currentRevealedState.push(false);
                    continue;
                }

                const box = createAnswerBox(number, answerObj.text, isRevealed, answerObj.points);
                col.appendChild(box);
                currentRevealedState.push(isRevealed);
            }

            colsWrapper.appendChild(col1);
            colsWrapper.appendChild(col2);
            answersContainer.appendChild(colsWrapper);

            scoreAEl.textContent = data.scoreA || 0;
            scoreBEl.textContent = data.scoreB || 0;

            if (currentActiveGameName) {
                for (let i = 0; i < currentRevealedState.length; i++) {
                    if (currentRevealedState[i] && (previousRevealedState[i] === false || previousRevealedState[i] === undefined)) {
                        playDing();
                        break;
                    }
                }
            }
            previousRevealedState = [...currentRevealedState];

            const currentStrikes = currentRound.strikes || 0;
            if (currentStrikes > previousStrikes && currentActiveGameName) {
                playBuzz();
            }
            previousStrikes = currentStrikes;


            [1, 2, 3].forEach(n => {
                const el = document.getElementById(`strike${n}`);
                if (el) {
                    if ((currentRound.strikes || 0) >= n) {
                        el.classList.remove('opacity-20');
                        el.classList.add('opacity-100');
                    } else {
                        el.classList.remove('opacity-100');
                        el.classList.add('opacity-20');
                    }
                }
            });

            if (data.rounds && data.rounds.length > 0) {
                roundNumberEl.textContent = `Round ${currentIndex + 1} / ${rounds.length}`;
            } else {
                 roundNumberEl.textContent = "Waiting for game to start...";
            }
        }

        // --- Modified displayFastMoneyRound function ---
        function displayFastMoneyRound(data) {
            const fastMoneyRounds = Array.isArray(data.fastMoneyRounds) ? data.fastMoneyRounds : [];
            const currentFMRoundIndex = data.currentFastMoneyRoundIndex ?? 0;
            const fastMoneyTotalPoints = data.fastMoneyTotalPoints ?? 0;

            const currentFMRound = fastMoneyRounds[currentFMRoundIndex] || { questions: [] };

            roundNumberEl.textContent = `Fast Money Round ${currentFMRoundIndex + 1}`;
            // Removed fastMoneyTimerEl.textContent update here
            fastMoneyTotalScoreEl.textContent = fastMoneyTotalPoints;

            // Display individual team scores in Fast Money (NEW)
            fastMoneyScoreAEl.textContent = data.scoreA || 0;
            fastMoneyScoreBEl.textContent = data.scoreB || 0;


            fastMoneyAnswersContainer.innerHTML = '';

            if (currentFMRound && currentFMRound.questions && currentFMRound.questions.length > 0) {
                currentFMRound.questions.forEach((qData, qIndex) => {
                    const questionBox = createFastMoneyAnswerBox(qData, qIndex);
                    if (questionBox) {
                        fastMoneyAnswersContainer.appendChild(questionBox);
                    }
                });
            } else {
                fastMoneyAnswersContainer.innerHTML = '<p class="text-center text-2xl col-span-2">No Fast Money questions for this round.</p>';
            }
        }


        // --- Initialize Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            startButton.addEventListener('click', () => {
                // --- FIX IS HERE: Hide the overlay IMMEDIATELY on click ---
                audioUnlockOverlay.style.display = 'none'; 
                console.log("User clicked to start. Attempting to play audio...");
        
                playIntro().then(() => {
                    console.log("Intro sound played successfully!");
                }).catch(e => {
                    console.error("Failed to play intro sound:", e);
                    // Optional: You could show a message here if audio is crucial and failed silently.
                    // For now, the overlay is already gone, which is the main goal.
                    alert("Audio playback may be restricted by your browser. Please ensure the tab is not muted or try clicking again if sounds don't work.");
                });
            }, { once: true }); // Ensure it only runs once

            onValue(ref(db, 'activeGame'), (activeGameSnapshot) => {
                const activeGameName = activeGameSnapshot.val();
                console.log(`Active game changed to: ${activeGameName}`);

                if (currentActiveGameName !== activeGameName) {
                    if (activeGameRef) {
                        off(activeGameRef);
                        activeGameRef = null;
                    }
                    previousRevealedState = [];
                    previousStrikes = 0;
                    currentActiveGameName = activeGameName;
                }

                if (activeGameName) {
                    activeGameRef = ref(db, `games/${activeGameName}`);
                    onValue(activeGameRef, (gameSnapshot) => {
                        const data = gameSnapshot.val();
                        if (data) {
                            updateDisplay(data);
                        } else {
                            console.warn(`Game data for ${activeGameName} not found.`);
                            roundNumberEl.textContent = "No active game selected.";
                            questionEl.textContent = "Waiting for host to select a game...";
                            answersContainer.innerHTML = '';
                            fastMoneyAnswersContainer.innerHTML = '';
                            scoreAEl.textContent = '0';
                            scoreBEl.textContent = '0';
                            fastMoneyScoreAEl.textContent = '0'; // Reset Fast Money scores too
                            fastMoneyScoreBEl.textContent = '0'; // Reset Fast Money scores too
                            fastMoneyTotalScoreEl.textContent = '0'; // Reset Fast Money total too
                            [1, 2, 3].forEach(n => {
                                document.getElementById(`strike${n}`).classList.remove('opacity-100');
                                document.getElementById(`strike${n}`).classList.add('opacity-20');
                            });
                            normalRoundUI.classList.remove('hidden');
                            normalRoundUI.classList.add('flex');
                            fastMoneyUI.classList.add('hidden');
                            fastMoneyUI.classList.remove('flex');
                        }
                    }, (error) => {
                        console.error("Error listening to active game data:", error);
                    });
                } else {
                    roundNumberEl.textContent = "No active game selected.";
                    questionEl.textContent = "Waiting for host to select a game...";
                    answersContainer.innerHTML = '';
                    fastMoneyAnswersContainer.innerHTML = '';
                    scoreAEl.textContent = '0';
                    scoreBEl.textContent = '0';
                    fastMoneyScoreAEl.textContent = '0'; // Reset Fast Money scores too
                    fastMoneyScoreBEl.textContent = '0'; // Reset Fast Money scores too
                    fastMoneyTotalScoreEl.textContent = '0'; // Reset Fast Money total too
                    [1, 2, 3].forEach(n => {
                        document.getElementById(`strike${n}`).classList.remove('opacity-100');
                        document.getElementById(`strike${n}`).classList.add('opacity-20');
                    });
                    normalRoundUI.classList.remove('hidden');
                    normalRoundUI.classList.add('flex');
                    fastMoneyUI.classList.add('hidden');
                    fastMoneyUI.classList.remove('flex');
                }
            }, (error) => {
                console.error("Error listening to activeGame path:", error);
            });
        });
    </script>
</body>
</html>
